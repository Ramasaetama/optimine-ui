console.log("ðŸ”„ AI Tools Script Loaded - Version: 2025-12-12");const AIToolsPage=(()=>{const e={isTyping:!1,messages:[],conversationId:null,isConnected:!1};let n,t,s,a,o;const i=e=>window.OptiMine&&window.OptiMine.LanguageManager?window.OptiMine.LanguageManager.t(e):e,r=()=>{const e=n.querySelector(".ai-message:first-child .message-bubble p");e&&(e.textContent=i("aiTools.welcomeMessage"))},d=()=>{const e=document.querySelectorAll(".suggested-prompt"),n=["aiTools.prompt1","aiTools.prompt2","aiTools.prompt3"];e.forEach((e,t)=>{n[t]&&(e.textContent=i(n[t]))})},l=()=>{const n=t.value.trim();n&&!e.isTyping&&(n.length>2e3?alert("Pesan terlalu panjang. Maksimal 2000 karakter."):(c(n,"user"),t.value="",s.disabled=!0,m(n)))},c=(t,s,a=!1)=>{const o=document.createElement("div");o.className=`chat-message ${s}-message flex items-start gap-3`;const i=v();o.innerHTML="ai"===s?`\n                <div class="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center flex-shrink-0">\n                    <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />\n                    </svg>\n                </div>\n                <div class="flex-1">\n                    <div class="message-bubble ai-bubble bg-secondary/50 border border-border rounded-2xl rounded-bl-sm p-4 max-w-[85%]">\n                        <div class="text-sm text-foreground">${a?t:w(t)}</div>\n                    </div>\n                    <span class="text-xs text-muted-foreground mt-1 block">${i}</span>\n                </div>\n            `:`\n                <div class="flex-1 flex justify-end">\n                    <div>\n                        <div class="message-bubble user-bubble p-4 max-w-[85%]">\n                            <p class="text-sm">${w(t)}</p>\n                        </div>\n                        <span class="text-xs text-muted-foreground mt-1 block text-right">${i}</span>\n                    </div>\n                </div>\n                <div class="w-8 h-8 rounded-lg bg-primary flex items-center justify-center flex-shrink-0">\n                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />\n                    </svg>\n                </div>\n            `,n.appendChild(o),e.messages.push({content:t,type:s,timestamp:i}),b()},u=()=>{try{const e=JSON.parse(localStorage.getItem("user")||"{}");return e.id||e.email||"anonymous"}catch{return"anonymous"}},g=e=>{const n=document.querySelector(".ai-status-indicator"),t=document.querySelector(".ai-status-text");n&&(e?(n.classList.remove("bg-red-500"),n.classList.add("bg-green-500")):(n.classList.remove("bg-green-500"),n.classList.add("bg-red-500"))),t&&(t.textContent=e?"AI Online":"AI Offline")},m=async n=>{e.isTyping=!0,y();try{const t=await(async n=>{const t=new AbortController,s=setTimeout(()=>t.abort(),3e4),a="https://n8n.optiminev.site/webhook/chatbot123";console.log("ðŸš€ Sending to n8n:",a),console.log("Message:",n);try{const o=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatInput:n,message:n,conversationId:e.conversationId,timestamp:(new Date).toISOString(),userId:u(),language:document.documentElement.lang||"id"}),signal:t.signal});if(clearTimeout(s),!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const i=await o.json();if(e.isConnected=!0,g(!0),console.log("âœ… n8n response received:",i),console.log("Response keys:",Object.keys(i)),i.output)return console.log("Using data.output"),i.output;if(i.text)return console.log("Using data.text"),i.text;if(i.response)return console.log("Using data.response"),i.response;if(i.message)return console.log("Using data.message"),i.message;if("string"==typeof i)return console.log("Data is string"),i;const r=["content","result","answer","reply","chatResponse"];for(const e of r)if(i[e]&&"string"==typeof i[e])return i[e];if(i.body&&"object"==typeof i.body){if(i.body.output)return i.body.output;if(i.body.text)return i.body.text}return JSON.stringify(i)}catch(n){throw clearTimeout(s),console.error("âŒ Error sending to n8n:",n),console.error("Error details:",{message:n.message,name:n.name,url:"https://n8n.optiminev.site/webhook/chatbot123"}),e.isConnected=!1,g(!1),n}})(n);f(),e.isTyping=!1,c(p(t),"ai",!0)}catch(t){f(),e.isTyping=!1;{console.log("Using fallback response");const e=h(n);c(e,"ai")}}},p=e=>e?e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/```([\s\S]*?)```/g,'<pre class="bg-secondary/50 p-2 rounded mt-2 mb-2 text-xs overflow-x-auto whitespace-pre-wrap">$1</pre>').replace(/`(.*?)`/g,'<code class="bg-secondary/50 px-1 rounded text-xs">$1</code>').replace(/\n/g,"<br>"):"",h=e=>{const n=e.toLowerCase();return n.includes("rainfall")||n.includes("rain")||n.includes("weather")||n.includes("curah hujan")?"Based on current weather data analysis:\n\nðŸ“Š **Current Conditions:**\n- Rainfall intensity: Moderate (15mm/hour)\n- 24-hour forecast: Light to moderate rain expected\n\nâš ï¸ **Operational Impact:**\n- Pit road conditions may be affected\n- Recommend reducing hauling speed by 20%\n- Consider postponing blasting operations\n\nâœ… **Recommendations:**\n1. Activate water pumping systems in low-lying areas\n2. Deploy additional graders for road maintenance\n3. Monitor stockpile moisture levels":n.includes("fleet")||n.includes("hauler")||n.includes("truck")||n.includes("armada")?"Fleet optimization analysis complete:\n\nðŸš› **Current Fleet Status:**\n- Total units: 24 active, 3 in maintenance\n- Average utilization: 78%\n- Fuel efficiency: 92% of target\n\nðŸ“ˆ **Optimization Opportunities:**\n- Route A-B shows 15% idle time - suggest rerouting\n- Night shift has 2 excess units\n\nâœ… **Recommended Actions:**\n1. Redistribute 2 units from Pit C to Pit A\n2. Schedule preventive maintenance for Unit #17\n3. Optimize crusher queue assignments":n.includes("ship")||n.includes("wave")||n.includes("port")||n.includes("kapal")||n.includes("gelombang")?"Shipping and port analysis:\n\nðŸŒŠ **Wave Conditions:**\n- Current wave height: 1.8m\n- Forecast (next 12h): 2.0-2.5m\n- Wind: 15 knots, NW direction\n\nðŸš¢ **Shipping Impact:**\n- MV Coal Star loading: On schedule\n- MV Pacific bulk: Delayed 6 hours (wave threshold)\n\nâœ… **Recommendations:**\n1. Prioritize MV Coal Star loading completion\n2. Prepare for potential 12-hour port closure\n3. Coordinate with stockpile management for buffer":n.includes("production")||n.includes("planning")||n.includes("produksi")||n.includes("target")?"Production planning summary:\n\nðŸ“Š **Today's Status:**\n- Target: 45,000 tonnes\n- Achieved: 32,500 tonnes (72%)\n- Projected EOD: 44,200 tonnes\n\nâš¡ **Key Factors:**\n- Morning shift exceeded target by 8%\n- Afternoon slowdown due to weather\n- Evening shift optimization in progress\n\nâœ… **Action Items:**\n1. Increase crusher throughput by 5%\n2. Optimize truck cycle times\n3. Coordinate with pit supervisors for catch-up plan":`Saya memahami pertanyaan Anda tentang "${e.substring(0,50)}${e.length>50?"...":""}". \n\nSaat ini AI sedang dalam mode offline. Saya dapat membantu Anda dengan:\n\nðŸ“Š **Analisis Dampak Cuaca** - Pengaruh curah hujan terhadap operasi\nðŸš› **Optimasi Armada** - Alokasi truk dan rute\nðŸŒŠ **Koordinasi Pengiriman** - Kondisi gelombang dan penjadwalan pelabuhan\nâš¡ **Perencanaan Produksi** - Tracking target dan prakiraan\n\nSilakan ajukan pertanyaan spesifik tentang area-area tersebut.\n\n*[Mode Fallback - Koneksi ke AI server sedang tidak tersedia]*`},y=()=>{a&&(a.classList.remove("hidden"),b())},f=()=>{a&&a.classList.add("hidden")},b=()=>{n&&(n.scrollTop=n.scrollHeight)},v=()=>(new Date).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),w=e=>{const n=document.createElement("div");return n.textContent=e,n.innerHTML};return{init:()=>{n=document.getElementById("chat-messages"),t=document.getElementById("chat-input"),s=document.getElementById("send-btn"),a=document.getElementById("typing-indicator"),o=document.querySelectorAll(".suggested-prompt"),n&&t&&s?(s.addEventListener("click",l),t.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),l())}),t.addEventListener("input",()=>{s.disabled=""===t.value.trim()}),o.forEach(e=>{e.addEventListener("click",()=>{const n=e.textContent.trim();t.value=n,t.focus(),s.disabled=!1})}),s.disabled=!0,window.addEventListener("languagechange",e=>{r(),d()}),r(),t.focus(),e.conversationId="conv_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),console.log("AI Tools Page initialized")):console.warn("AI Tools: Required elements not found")},addMessage:c,getState:()=>({...e})}})();document.addEventListener("DOMContentLoaded",()=>{document.getElementById("chat-messages")&&AIToolsPage.init()});