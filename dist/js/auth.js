const AuthPage=(()=>{const e={currentView:"login",isLoading:!1,selectedRole:null};let t,o,a,s,n,r,i,d,l,c,m,g;const u=e=>window.OptiMine&&window.OptiMine.LanguageManager?window.OptiMine.LanguageManager.t(e):e,h=r=>{if(e.isLoading)return;e.currentView=r,"login"===r?(t.classList.add("active"),o.classList.remove("active"),a.classList.remove("hidden"),s.classList.add("hidden"),n.classList.add("hidden")):"register"===r&&(t.classList.remove("active"),o.classList.add("active"),a.classList.add("hidden"),s.classList.remove("hidden"),n.classList.add("hidden"));const i=new URL(window.location);i.searchParams.set("tab",r),window.history.replaceState({},"",i),k()},p=async t=>{if(t.preventDefault(),e.isLoading)return;const o=document.getElementById("login-email").value.trim(),s=document.getElementById("login-password").value;if(I(o))if(s){q(!0,a);try{const e=await fetch("http://localhost:5000/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,password:s})}),t=await e.json();if(!e.ok||t.error)throw new Error(t.message||"Login failed");localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-token",t.data.token),localStorage.setItem("optimine-user",JSON.stringify({id:t.data.id,email:o,name:t.data.nama,role:t.data.role,avatar:null})),O("success",u("auth.loginSuccess")||"Login successful! Redirecting..."),setTimeout(()=>{const e=localStorage.getItem("optimine-redirect")||"index.html";localStorage.removeItem("optimine-redirect"),window.location.href=e},1500)}catch(e){O("error",e.message||u("auth.loginError")||"Invalid email or password")}finally{q(!1,a)}}else b("login-password",u("auth.passwordRequired")||"Password is required");else b("login-email",u("auth.invalidEmail")||"Please enter a valid email address")},w=async t=>{if(t.preventDefault(),e.isLoading)return;const o=document.getElementById("register-name").value.trim(),a=document.getElementById("register-email").value.trim(),n=document.getElementById("register-password").value,r=document.getElementById("register-confirm-password").value,i=document.getElementById("register-role").value;let d=!1;if((!o||o.length<2)&&(b("register-name",u("auth.nameRequired")||"Please enter your full name"),d=!0),I(a)||(b("register-email",u("auth.invalidEmail")||"Please enter a valid email address"),d=!0),n.length<8&&(b("register-password",u("auth.passwordMinLength")||"Password must be at least 8 characters"),d=!0),n!==r&&(b("register-confirm-password",u("auth.passwordMismatch")||"Passwords do not match"),d=!0),i||(b("role-dropdown-btn",u("auth.roleRequired")||"Please select a role"),d=!0),!d){q(!0,s);try{const e={nama:o,email:a,password:n,role:i};console.log("Sending registration data:",e);const t=await fetch("http://localhost:5000/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),s=await t.json();if(console.log("Registration response:",s),!t.ok||s.error)throw new Error(s.message||"Registration failed");const r=await fetch("http://localhost:5000/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,password:n})}),d=await r.json();r.ok&&!d.error?(localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-token",d.data.token),localStorage.setItem("optimine-user",JSON.stringify({id:d.data.id,email:a,name:d.data.nama,role:d.data.role,avatar:null}))):(localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-user",JSON.stringify({email:a,name:o,role:i,avatar:null}))),O("success",u("auth.registerSuccess")||"Account created successfully! Redirecting..."),setTimeout(()=>{window.location.href="index.html"},1500)}catch(e){O("error",e.message||u("auth.registerError")||"Registration failed. Please try again.")}finally{q(!1,s)}}},y=async()=>{if(e.isLoading)return;const t=document.getElementById("forgot-email").value.trim();if(I(t)){q(!0,n);try{await M(),O("success",u("auth.resetEmailSent")||"Password reset link has been sent to your email.")}catch(e){O("error",u("auth.resetError")||"Failed to send reset link. Please try again.")}finally{q(!1,n)}}else b("forgot-email",u("auth.invalidEmail")||"Please enter a valid email address")},v=()=>{l.classList.contains("hidden")?(l.classList.remove("hidden"),c.classList.add("open")):L()},L=()=>{l.classList.add("hidden"),c.classList.remove("open")},f=t=>{const o=t.dataset.value,a=t.querySelector("span").textContent;e.selectedRole=o,g.value=o,m.textContent=a,m.classList.remove("text-muted-foreground"),m.classList.add("text-foreground"),l.querySelectorAll(".role-option").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),L(),P("role-dropdown-btn")},E=()=>{e.currentView="forgot",a.classList.add("hidden"),s.classList.add("hidden"),n.classList.remove("hidden"),t.parentElement.classList.add("hidden")},S=()=>{e.currentView="login",n.classList.add("hidden"),a.classList.remove("hidden"),t.parentElement.classList.remove("hidden")},I=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),B=()=>{document.querySelectorAll('input[type="email"]').forEach(e=>{e.addEventListener("blur",()=>{e.value&&!I(e.value)?b(e.id,u("auth.invalidEmail")||"Please enter a valid email address"):P(e.id)})});const e=document.getElementById("register-confirm-password"),t=document.getElementById("register-password");e&&t&&e.addEventListener("blur",()=>{e.value&&e.value!==t.value?b("register-confirm-password",u("auth.passwordMismatch")||"Passwords do not match"):P("register-confirm-password")})},b=(e,t)=>{const o=document.getElementById(e);if(!o)return;o.classList.add("error");const a=o.parentElement.querySelector(".error-message");a&&a.remove();const s=document.createElement("p");s.className="error-message",s.textContent=t,o.parentElement.appendChild(s)},P=e=>{const t=document.getElementById(e);if(!t)return;t.classList.remove("error");const o=t.parentElement.querySelector(".error-message");o&&o.remove()},k=()=>{document.querySelectorAll(".auth-input.error").forEach(e=>{e.classList.remove("error")}),document.querySelectorAll(".error-message").forEach(e=>e.remove())},q=(t,o)=>{e.isLoading=t;const a=o.querySelector(".auth-submit")||o.querySelector('button[type="submit"]')||o.querySelector("#send-reset-link");a&&(t?(a.classList.add("loading"),a.disabled=!0,a.querySelector(".loading-spinner")?.classList.remove("hidden")):(a.classList.remove("loading"),a.disabled=!1,a.querySelector(".loading-spinner")?.classList.add("hidden")))},O=(e,t)=>{window.OptiMine&&window.OptiMine.Toast?window.OptiMine.Toast.show(t,e):alert(t)},M=()=>new Promise(e=>{setTimeout(e,1500)});return{init:()=>{t=document.getElementById("login-tab"),o=document.getElementById("register-tab"),a=document.getElementById("login-form"),s=document.getElementById("register-form"),n=document.getElementById("forgot-password-form"),r=document.getElementById("forgot-password-link"),i=document.getElementById("back-to-login"),d=document.getElementById("role-dropdown-btn"),l=document.getElementById("role-dropdown"),c=document.getElementById("role-chevron"),m=document.getElementById("selected-role"),g=document.getElementById("register-role"),t&&o?(t.addEventListener("click",()=>h("login")),o.addEventListener("click",()=>h("register")),(()=>{a&&a.addEventListener("submit",p),s&&s.addEventListener("submit",w);const e=document.getElementById("send-reset-link");e&&e.addEventListener("click",y),B()})(),d&&l&&(d.addEventListener("click",e=>{e.preventDefault(),v()}),document.addEventListener("click",e=>{d.contains(e.target)||l.contains(e.target)||L()}),l.querySelectorAll(".role-option").forEach(e=>{e.addEventListener("click",()=>{f(e)})})),document.querySelectorAll(".password-toggle").forEach(e=>{e.addEventListener("click",()=>{const t=e.parentElement.querySelector("input"),o=e.querySelector(".eye-open"),a=e.querySelector(".eye-closed");"password"===t.type?(t.type="text",o.classList.add("hidden"),a.classList.remove("hidden")):(t.type="password",o.classList.remove("hidden"),a.classList.add("hidden"))})}),r&&r.addEventListener("click",e=>{e.preventDefault(),E()}),i&&i.addEventListener("click",()=>{S()}),"register"===new URLSearchParams(window.location.search).get("tab")&&h("register"),console.log("Auth Page initialized")):console.warn("Auth Page: Required elements not found")},switchTab:h,getState:()=>({...e})}})();function handleLogout(){localStorage.removeItem("optimine-logged-in"),localStorage.removeItem("optimine-user"),localStorage.removeItem("optimine-redirect"),window.OptiMine&&window.OptiMine.Toast&&window.OptiMine.Toast.show("Logged out successfully","success"),setTimeout(()=>{window.location.href="index.html"},500)}function isLoggedIn(){return"true"===localStorage.getItem("optimine-logged-in")}function getUserData(){try{return JSON.parse(localStorage.getItem("optimine-user")||"{}")}catch{return{}}}document.addEventListener("DOMContentLoaded",()=>{(document.getElementById("login-form")||document.getElementById("register-form"))&&AuthPage.init()}),window.handleLogout=handleLogout,window.isLoggedIn=isLoggedIn,window.getUserData=getUserData;