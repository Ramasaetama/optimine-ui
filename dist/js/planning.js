const PLAN_API_URL="http://139.59.224.58:5000/ai/plan",SHIPPING_API_URL="http://139.59.224.58:5000/shipping-schedules",PlanningPage={state:{rainfall_mm:.5,wind_speed_kmh:.4,activeVehicles:25,maintenanceStatus:3,totalFleet:40,vessels:[],isLoading:!1,result:null},loadingSteps:[{icon:"üì°",text:"Mengirim data telemetri ke Server...",duration:2e3},{icon:"üå©Ô∏è",text:"Menganalisis dampak cuaca & gelombang...",duration:2e3},{icon:"ü§ñ",text:"AI menyusun strategi optimal...",duration:null}],init(){this.setupSliders(),this.setupInputs(),this.setupGenerateButton(),this.updateSliderFill(),this.updateSliderValueDisplays(),this.injectResultContainers(),this.loadVessels()},async loadVessels(){const e=document.getElementById("vessels-container");if(e)try{const t=localStorage.getItem("optimine-token"),n={"Content-Type":"application/json"};t&&(n.Authorization=`Bearer ${t}`);const a=await fetch(`${SHIPPING_API_URL}?limit=5`,{headers:n});if(!a.ok)throw new Error(`HTTP ${a.status}`);const s=(await a.json()).data||[];if(0===s.length)return void this.renderDefaultVessels(e);this.state.vessels=s.map(e=>({id:e.shipment_id,name:e.vessel_name,etd:e.etd,status:e.status,destination:e.destination_port,tonnage:e.coal_tonnage})),this.renderVessels(e,s)}catch(t){console.warn("Failed to load vessels, using defaults:",t.message),this.renderDefaultVessels(e)}},renderVessels(e,t){e.innerHTML=t.map(e=>{const t=e.etd?new Date(e.etd):null,n=t?t.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}):"-",a="scheduled"===e.status?.toLowerCase()||"loading"===e.status?.toLowerCase()?"bg-primary/20 text-primary":"bg-emerald-500/20 text-emerald-400",s=e.status||"Scheduled";return`\n                <div class="flex items-center justify-between p-3 bg-secondary/30 rounded-lg border border-border">\n                    <div class="flex-1">\n                        <span class="text-sm font-medium text-foreground">${e.vessel_name||"Unknown Vessel"}</span>\n                        <span class="text-xs text-muted-foreground ml-2">ETD: ${n}</span>\n                    </div>\n                    <div class="flex items-center gap-2">\n                        <span class="text-xs text-muted-foreground">${e.coal_tonnage?.toLocaleString()||"-"} ton</span>\n                        <span class="px-2 py-1 text-xs font-medium ${a} rounded">${s}</span>\n                    </div>\n                </div>\n            `}).join("")},renderDefaultVessels(e){this.state.vessels=[{id:"A",name:"MV Samudera Jaya",time:"08:00",status:"Scheduled"},{id:"B",name:"MV Nusantara",time:"14:00",status:"Loading"},{id:"C",name:"MV Bahari Indah",time:"20:00",status:"Scheduled"}],e.innerHTML=this.state.vessels.map(e=>`\n            <div class="flex items-center justify-between p-3 bg-secondary/30 rounded-lg border border-border">\n                <span class="text-sm text-foreground">${e.name} - ${e.time}</span>\n                <span class="px-2 py-1 text-xs font-medium bg-primary/20 text-primary rounded">${e.status}</span>\n            </div>\n        `).join("")},injectResultContainers(){const e=document.getElementById("generate-btn");if(!e)return;e.insertAdjacentHTML("afterend",'\n            <div id="loading-container" class="hidden w-full">\n                <div class="glass border border-border rounded-xl p-8 animate-fade-in">\n                    <div class="flex flex-col items-center justify-center gap-4">\n                        <div class="relative">\n                            <div class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center">\n                                <span id="loading-icon" class="text-3xl">üì°</span>\n                            </div>\n                            <div class="absolute inset-0 w-16 h-16 rounded-full border-4 border-primary/30 border-t-primary animate-spin"></div>\n                        </div>\n                        <p id="loading-text" class="text-lg font-medium text-foreground text-center">\n                            Mengirim data telemetri ke Server...\n                        </p>\n                        <div class="flex gap-2 mt-2">\n                            <div class="w-2 h-2 rounded-full bg-primary animate-pulse" style="animation-delay: 0ms;"></div>\n                            <div class="w-2 h-2 rounded-full bg-primary animate-pulse" style="animation-delay: 200ms;"></div>\n                            <div class="w-2 h-2 rounded-full bg-primary animate-pulse" style="animation-delay: 400ms;"></div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        '),e.insertAdjacentHTML("afterend",'\n            <div id="result-dashboard" class="hidden w-full space-y-6 animate-fade-in">\n                <div class="flex items-center justify-between flex-wrap gap-4">\n                    <div class="flex items-center gap-3">\n                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-primary to-cyan-500 flex items-center justify-center">\n                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />\n                            </svg>\n                        </div>\n                        <div>\n                            <h2 class="font-heading font-bold text-xl text-foreground">Rencana Optimasi Operasional</h2>\n                            <p id="result-timestamp" class="text-sm text-muted-foreground"></p>\n                        </div>\n                    </div>\n                    <button id="new-plan-btn" class="px-4 py-2 text-sm font-medium text-primary hover:bg-primary/10 rounded-lg transition-colors flex items-center gap-2">\n                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />\n                        </svg>\n                        Buat Rencana Baru\n                    </button>\n                </div>\n                <div class="grid sm:grid-cols-3 gap-4" id="metrics-grid"></div>\n                <div id="recommendations-container" class="space-y-4"></div>\n            </div>\n        ');const t=document.getElementById("new-plan-btn");t&&t.addEventListener("click",()=>this.resetToInput())},setupSliders(){const e=document.getElementById("rainfall-slider"),t=document.getElementById("wave-slider");e&&(e.addEventListener("input",e=>{this.state.rainfall_mm=parseFloat(e.target.value),this.updateSliderFill(e.target),this.updateSliderValueDisplays(),this.onStateChange()}),this.updateSliderFill(e)),t&&(t.addEventListener("input",e=>{this.state.wind_speed_kmh=parseFloat(e.target.value),this.updateSliderFill(e.target),this.updateSliderValueDisplays(),this.onStateChange()}),this.updateSliderFill(t))},updateSliderValueDisplays(){const e=document.getElementById("rainfall-value"),t=document.getElementById("wind-value");e&&(e.textContent=`${this.state.rainfall_mm.toFixed(1)} mm`),t&&(t.textContent=`${this.state.wind_speed_kmh.toFixed(1)} km/h`)},updateSliderFill(e){if(!e)return void document.querySelectorAll(".custom-slider").forEach(e=>this.updateSliderFill(e));const t=parseFloat(e.value),n=parseFloat(e.min)||0,a=(t-n)/((parseFloat(e.max)||100)-n)*100,s=getComputedStyle(document.documentElement).getPropertyValue("--primary").trim();e.style.background=`linear-gradient(to right, \n            hsl(${s||"199 89% 48%"}) 0%, \n            hsl(${s||"199 89% 48%"}) ${a}%, \n            hsl(var(--secondary)) ${a}%, \n            hsl(var(--secondary)) 100%)`},setupInputs(){const e=document.getElementById("active-vehicles"),t=document.getElementById("maintenance-status");e&&(e.addEventListener("change",e=>{this.state.activeVehicles=parseInt(e.target.value)||0,this.onStateChange()}),e.addEventListener("focus",e=>e.target.select())),t&&(t.addEventListener("change",e=>{this.state.maintenanceStatus=parseInt(e.target.value)||0,this.onStateChange()}),t.addEventListener("focus",e=>e.target.select()))},setupGenerateButton(){const e=document.getElementById("generate-btn");e&&e.addEventListener("click",()=>this.generateOptimizationPlan())},buildPayload(){const e={rainfall_mm:this.state.rainfall_mm,wind_speed_kmh:this.state.wind_speed_kmh,temperature_c:30,humidity_pct:80};let t="Mendung";this.state.rainfall_mm>=1?t="Hujan ringan":this.state.rainfall_mm<.1&&(t="Berawan");const n=this.state.activeVehicles/this.state.totalFleet*100;let a="Good";this.state.rainfall_mm>=1?a="Poor":this.state.rainfall_mm>=.3&&(a="Fair");const s={availability_pct:parseFloat(n.toFixed(2)),road_condition:a,weather_condition:t,mine_id:"MINE_1",equipment_type:"Excavator"},i=this.state.vessels.map(e=>e.name?`${e.name} (${e.status})`:`Vessel ${e.id} - ${e.time} (${e.status})`).join(", ");return{weather_input:e,capacity_input:s,production_input:{planned_output_ton:5e3},additional_context:`Status cuaca: ${t}, curah hujan ${this.state.rainfall_mm.toFixed(1)}mm, angin ${this.state.wind_speed_kmh.toFixed(1)}km/h. Armada: ${this.state.activeVehicles} aktif dari ${this.state.totalFleet} total, ${this.state.maintenanceStatus} dalam perawatan. Kondisi jalan: ${a}. Jadwal kapal: ${i||"Tidak ada data"}.`}},async generateOptimizationPlan(){if(this.state.isLoading)return;const e=document.getElementById("generate-btn"),t=document.getElementById("loading-container"),n=document.getElementById("result-dashboard");e&&e.classList.add("hidden"),n&&n.classList.add("hidden"),t&&t.classList.remove("hidden"),this.state.isLoading=!0;const a=this.runLoadingAnimation();try{const e=this.buildPayload();console.log("üì§ Sending payload to AI Plan:",e);const t=await fetch(PLAN_API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();console.log("üì• AI Plan response:",n),this.state.result=n,await a,this.renderResultDashboard(n),window.OptiMine&&window.OptiMine.Toast&&window.OptiMine.Toast.success("Rencana optimasi berhasil dibuat!")}catch(e){console.error("‚ùå Error generating plan:",e),console.log("üé≠ Menggunakan Demo Mode karena API belum tersedia..."),await a;const t=this.generateDemoResult();this.state.result=t,this.renderResultDashboard(t),window.OptiMine&&window.OptiMine.Toast&&window.OptiMine.Toast.info("Demo Mode: Menampilkan contoh hasil (Backend belum terhubung)")}finally{this.state.isLoading=!1}},generateDemoResult(){const e=this.getWeatherClassFromRainfall(this.state.rainfall_mm),t=Math.round(this.state.activeVehicles/this.state.totalFleet*5e3);return{success:!0,data:{ml_predictions:{weather_classification:e,effective_capacity_ton_per_day:t,confidence_score:.87,production_forecast:.9*t},narrative_recommendation:`\n**Strategi Utama:**\nBerdasarkan analisis kondisi cuaca ${e} dengan curah hujan ${this.state.rainfall_mm.toFixed(1)}mm, disarankan untuk mengoptimalkan jadwal operasional pada shift pagi ketika kondisi jalan masih optimal.\n\n**Risiko Terdeteksi:**\n- Curah hujan ${this.state.rainfall_mm>=1?"tinggi dapat menurunkan kapasitas hauling sebesar 15-20%":"rendah, kondisi operasional normal"}\n- ${this.state.maintenanceStatus} unit kendaraan dalam perawatan perlu diprioritaskan untuk kembali beroperasi\n- Kecepatan angin ${this.state.wind_speed_kmh.toFixed(1)} km/h ${this.state.wind_speed_kmh>5?"perlu monitoring untuk keamanan operasi crane":"dalam batas aman"}\n\n**Tindakan Prioritas:**\n1. Fokuskan operasi pada ${this.state.activeVehicles} unit kendaraan aktif\n2. Koordinasi dengan jadwal kapal untuk optimasi loading\n3. Monitor kondisi jalan secara berkala terutama area ramp\n4. Siapkan contingency plan jika cuaca memburuk\n                `.trim()}}},async runLoadingAnimation(){const e=document.getElementById("loading-icon"),t=document.getElementById("loading-text");for(let n=0;n<this.loadingSteps.length-1;n++){const a=this.loadingSteps[n];e&&(e.textContent=a.icon),t&&(t.textContent=a.text),await this.sleep(a.duration)}const n=this.loadingSteps[this.loadingSteps.length-1];e&&(e.textContent=n.icon),t&&(t.textContent=n.text)},sleep:e=>new Promise(t=>setTimeout(t,e)),renderResultDashboard(e){const t=document.getElementById("loading-container"),n=document.getElementById("result-dashboard"),a=document.getElementById("generate-btn");t&&t.classList.add("hidden"),a&&a.classList.add("hidden"),n&&n.classList.remove("hidden");const s=document.getElementById("result-timestamp");if(s){const e=new Date;s.textContent=`Dibuat pada ${e.toLocaleString("id-ID",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}`}this.renderMetrics(e.data||e),this.renderRecommendations(e.data||e)},renderMetrics(e){const t=document.getElementById("metrics-grid");if(!t)return;const n=e.ml_predictions||{},a=n.weather_classification||this.getWeatherClassFromRainfall(this.state.rainfall_mm),s=this.getWeatherIcon(a),i=n.effective_capacity_ton_per_day||n.capacity_forecast||50*this.state.activeVehicles,r=n.confidence_score||n.model_confidence||.85;t.innerHTML=`\n            <div class="glass border border-border rounded-xl p-5 transition-all hover:border-primary/50">\n                <div class="flex items-center gap-3 mb-3">\n                    <span class="text-3xl">${s}</span>\n                    <span class="text-sm text-muted-foreground">Kondisi Cuaca</span>\n                </div>\n                <p class="text-xl font-bold text-foreground">${a}</p>\n                <p class="text-xs text-muted-foreground mt-1">\n                    ${this.state.rainfall_mm.toFixed(1)}mm curah hujan, ${this.state.wind_speed_kmh.toFixed(1)}km/h angin\n                </p>\n            </div>\n            \n            <div class="glass border border-border rounded-xl p-5 transition-all hover:border-primary/50">\n                <div class="flex items-center gap-3 mb-3">\n                    <span class="text-3xl">‚öôÔ∏è</span>\n                    <span class="text-sm text-muted-foreground">Kapasitas Efektif</span>\n                </div>\n                <p class="text-xl font-bold text-foreground">${Math.round(i).toLocaleString("id-ID")}</p>\n                <p class="text-xs text-muted-foreground mt-1">Ton/Hari</p>\n            </div>\n            \n            <div class="glass border border-border rounded-xl p-5 transition-all hover:border-primary/50">\n                <div class="flex items-center gap-3 mb-3">\n                    <span class="text-3xl">üìä</span>\n                    <span class="text-sm text-muted-foreground">Confidence Score</span>\n                </div>\n                <p class="text-xl font-bold text-foreground">${(100*r).toFixed(1)}%</p>\n                <div class="w-full h-2 bg-secondary rounded-full mt-2 overflow-hidden">\n                    <div class="h-full bg-gradient-to-r from-primary to-cyan-500 rounded-full" \n                         style="width: ${100*r}%"></div>\n                </div>\n            </div>\n        `},getWeatherClassFromRainfall:e=>e>=1?"Hujan ringan":e>=.3?"Mendung":"Berawan",getWeatherIcon(e){const t=e.toLowerCase();return t.includes("hujan")?"üåßÔ∏è":t.includes("mendung")?"‚òÅÔ∏è":"‚õÖ"},renderRecommendations(e){const t=document.getElementById("recommendations-container");if(!t)return;const n=e.narrative_recommendation||e.recommendation||e.response||"Tidak ada rekomendasi tersedia.",a=this.parseNarrativeToSections(n);let s="";a.strategy&&(s+=this.createRecommendationCard("üìå","Strategi Utama",a.strategy,"from-primary/20 to-cyan-500/20")),a.risks&&(s+=this.createRecommendationCard("‚ö†Ô∏è","Risiko Terdeteksi",a.risks,"from-yellow-500/20 to-orange-500/20")),a.actions&&(s+=this.createRecommendationCard("‚úÖ","Tindakan Prioritas",a.actions,"from-emerald-500/20 to-green-500/20")),a.strategy||a.risks||a.actions||(s=this.createRecommendationCard("üí°","Rekomendasi AI",n,"from-primary/20 to-blue-500/20")),t.innerHTML=s},stripMarkdown:e=>e.replace(/\*\*([^*]+)\*\*/g,"$1").replace(/\*([^*]+)\*/g,"$1").replace(/^#{1,6}\s+/gm,"").replace(/^(Strategi Utama|Risiko Terdeteksi|Tindakan Prioritas):\s*/gi,"").trim(),createRecommendationCard(e,t,n,a){let s=this.stripMarkdown(n),i=s;if(s.includes("\n")||s.includes("‚Ä¢")||s.includes("-")){const e=s.split(/[\n‚Ä¢-]/).map(e=>e.trim()).filter(e=>e.length>0);i=e.length>1?'<ul class="list-disc list-inside space-y-2">'+e.map(e=>`<li class="text-muted-foreground">${e}</li>`).join("")+"</ul>":`<p class="text-muted-foreground">${s}</p>`}else i=`<p class="text-muted-foreground">${s}</p>`;return`\n            <div class="glass border border-border rounded-xl overflow-hidden">\n                <div class="bg-gradient-to-r ${a} px-5 py-4 border-b border-border/50">\n                    <div class="flex items-center gap-3">\n                        <span class="text-2xl">${e}</span>\n                        <h3 class="font-heading font-semibold text-lg text-foreground">${t}</h3>\n                    </div>\n                </div>\n                <div class="p-5">${i}</div>\n            </div>\n        `},parseNarrativeToSections(e){const t={strategy:"",risks:"",actions:""},n=e.match(/\*\*Strategi Utama:\*\*\s*([\s\S]*?)(?=\*\*Risiko|\*\*Tindakan|$)/i),a=e.match(/\*\*Risiko Terdeteksi:\*\*\s*([\s\S]*?)(?=\*\*Strategi|\*\*Tindakan|$)/i),s=e.match(/\*\*Tindakan Prioritas:\*\*\s*([\s\S]*?)(?=\*\*Strategi|\*\*Risiko|$)/i);if(n&&n[1]&&(t.strategy=n[1].trim()),a&&a[1]&&(t.risks=a[1].trim()),s&&s[1]&&(t.actions=s[1].trim()),!t.strategy&&!t.risks&&!t.actions){const n=e.split(/\n\n/).filter(e=>e.trim());n.length>=1&&(t.strategy=n[0]),n.length>=2&&(t.risks=n[1]),n.length>=3&&(t.actions=n.slice(2).join("\n"))}return t},resetToInput(){const e=document.getElementById("generate-btn"),t=document.getElementById("loading-container"),n=document.getElementById("result-dashboard");e&&e.classList.remove("hidden"),t&&t.classList.add("hidden"),n&&n.classList.add("hidden"),this.state.result=null},onStateChange(){window.dispatchEvent(new CustomEvent("planning:statechange",{detail:{state:this.state}})),console.log("Planning state updated:",this.state)},getState(){return{...this.state}},setState(e){this.state={...this.state,...e};const t=document.getElementById("rainfall-slider"),n=document.getElementById("wave-slider"),a=document.getElementById("active-vehicles"),s=document.getElementById("maintenance-status");t&&void 0!==e.rainfall_mm&&(t.value=e.rainfall_mm,this.updateSliderFill(t)),n&&void 0!==e.wind_speed_kmh&&(n.value=e.wind_speed_kmh,this.updateSliderFill(n)),a&&void 0!==e.activeVehicles&&(a.value=e.activeVehicles),s&&void 0!==e.maintenanceStatus&&(s.value=e.maintenanceStatus),this.updateSliderValueDisplays()}};document.addEventListener("DOMContentLoaded",()=>{document.getElementById("generate-btn")&&(PlanningPage.init(),window.addEventListener("themechange",()=>PlanningPage.updateSliderFill()))}),window.PlanningPage=PlanningPage;