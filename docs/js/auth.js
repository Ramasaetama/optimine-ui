const AuthPage=(()=>{const e={currentView:"login",isLoading:!1,selectedRole:null};let t,a,o,n,r,s,i,d,l,c,m,g;const u=e=>window.OptiMine&&window.OptiMine.LanguageManager?window.OptiMine.LanguageManager.t(e):e,h=s=>{if(e.isLoading)return;e.currentView=s,"login"===s?(t.classList.add("active"),a.classList.remove("active"),o.classList.remove("hidden"),n.classList.add("hidden"),r.classList.add("hidden")):"register"===s&&(t.classList.remove("active"),a.classList.add("active"),o.classList.add("hidden"),n.classList.remove("hidden"),r.classList.add("hidden"));const i=new URL(window.location);i.searchParams.set("tab",s),window.history.replaceState({},"",i),k()},p=async t=>{if(t.preventDefault(),e.isLoading)return;const a=document.getElementById("login-email").value.trim(),n=document.getElementById("login-password").value;if(I(a))if(n){q(!0,o);try{const e=await fetch("http://139.59.224.58:5000/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,password:n})}),t=await e.json();if(!e.ok||t.error)throw new Error(t.message||"Login failed");localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-token",t.data.token),localStorage.setItem("optimine-user",JSON.stringify({id:t.data.id,email:a,name:t.data.nama,role:t.data.role,avatar:null})),O("success",u("auth.loginSuccess")||"Login successful! Redirecting..."),setTimeout(()=>{const e=localStorage.getItem("optimine-redirect")||"index.html";localStorage.removeItem("optimine-redirect"),window.location.href=e},1500)}catch(e){O("error",e.message||u("auth.loginError")||"Invalid email or password")}finally{q(!1,o)}}else b("login-password",u("auth.passwordRequired")||"Password is required");else b("login-email",u("auth.invalidEmail")||"Please enter a valid email address")},w=async t=>{if(t.preventDefault(),e.isLoading)return;const a=document.getElementById("register-name").value.trim(),o=document.getElementById("register-email").value.trim(),r=document.getElementById("register-password").value,s=document.getElementById("register-confirm-password").value,i=document.getElementById("register-role").value;let d=!1;if((!a||a.length<2)&&(b("register-name",u("auth.nameRequired")||"Please enter your full name"),d=!0),I(o)||(b("register-email",u("auth.invalidEmail")||"Please enter a valid email address"),d=!0),r.length<8&&(b("register-password",u("auth.passwordMinLength")||"Password must be at least 8 characters"),d=!0),r!==s&&(b("register-confirm-password",u("auth.passwordMismatch")||"Passwords do not match"),d=!0),i||(b("role-dropdown-btn",u("auth.roleRequired")||"Please select a role"),d=!0),!d){q(!0,n);try{const e={nama:a,email:o,password:r,role:i};console.log("Sending registration data:",e);const t=await fetch("http://139.59.224.58:5000/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await t.json();if(console.log("Registration response:",n),!t.ok||n.error)throw new Error(n.message||"Registration failed");const s=await fetch("http://139.59.224.58:5000/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:o,password:r})}),d=await s.json();s.ok&&!d.error?(localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-token",d.data.token),localStorage.setItem("optimine-user",JSON.stringify({id:d.data.id,email:o,name:d.data.nama,role:d.data.role,avatar:null}))):(localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-user",JSON.stringify({email:o,name:a,role:i,avatar:null}))),O("success",u("auth.registerSuccess")||"Account created successfully! Redirecting..."),setTimeout(()=>{window.location.href="index.html"},1500)}catch(e){O("error",e.message||u("auth.registerError")||"Registration failed. Please try again.")}finally{q(!1,n)}}},y=async()=>{if(e.isLoading)return;const t=document.getElementById("forgot-email").value.trim();if(I(t)){q(!0,r);try{await M(),O("success",u("auth.resetEmailSent")||"Password reset link has been sent to your email.")}catch(e){O("error",u("auth.resetError")||"Failed to send reset link. Please try again.")}finally{q(!1,r)}}else b("forgot-email",u("auth.invalidEmail")||"Please enter a valid email address")},v=()=>{l.classList.contains("hidden")?(l.classList.remove("hidden"),c.classList.add("open")):L()},L=()=>{l.classList.add("hidden"),c.classList.remove("open")},f=t=>{const a=t.dataset.value,o=t.querySelector("span").textContent;e.selectedRole=a,g.value=a,m.textContent=o,m.classList.remove("text-muted-foreground"),m.classList.add("text-foreground"),l.querySelectorAll(".role-option").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),L(),P("role-dropdown-btn")},E=()=>{e.currentView="forgot",o.classList.add("hidden"),n.classList.add("hidden"),r.classList.remove("hidden"),t.parentElement.classList.add("hidden")},S=()=>{e.currentView="login",r.classList.add("hidden"),o.classList.remove("hidden"),t.parentElement.classList.remove("hidden")},I=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),B=()=>{document.querySelectorAll('input[type="email"]').forEach(e=>{e.addEventListener("blur",()=>{e.value&&!I(e.value)?b(e.id,u("auth.invalidEmail")||"Please enter a valid email address"):P(e.id)})});const e=document.getElementById("register-confirm-password"),t=document.getElementById("register-password");e&&t&&e.addEventListener("blur",()=>{e.value&&e.value!==t.value?b("register-confirm-password",u("auth.passwordMismatch")||"Passwords do not match"):P("register-confirm-password")})},b=(e,t)=>{const a=document.getElementById(e);if(!a)return;a.classList.add("error");const o=a.parentElement.querySelector(".error-message");o&&o.remove();const n=document.createElement("p");n.className="error-message",n.textContent=t,a.parentElement.appendChild(n)},P=e=>{const t=document.getElementById(e);if(!t)return;t.classList.remove("error");const a=t.parentElement.querySelector(".error-message");a&&a.remove()},k=()=>{document.querySelectorAll(".auth-input.error").forEach(e=>{e.classList.remove("error")}),document.querySelectorAll(".error-message").forEach(e=>e.remove())},q=(t,a)=>{e.isLoading=t;const o=a.querySelector(".auth-submit")||a.querySelector('button[type="submit"]')||a.querySelector("#send-reset-link");o&&(t?(o.classList.add("loading"),o.disabled=!0,o.querySelector(".loading-spinner")?.classList.remove("hidden")):(o.classList.remove("loading"),o.disabled=!1,o.querySelector(".loading-spinner")?.classList.add("hidden")))},O=(e,t)=>{window.OptiMine&&window.OptiMine.Toast?window.OptiMine.Toast.show(t,e):alert(t)},M=()=>new Promise(e=>{setTimeout(e,1500)});return{init:()=>{t=document.getElementById("login-tab"),a=document.getElementById("register-tab"),o=document.getElementById("login-form"),n=document.getElementById("register-form"),r=document.getElementById("forgot-password-form"),s=document.getElementById("forgot-password-link"),i=document.getElementById("back-to-login"),d=document.getElementById("role-dropdown-btn"),l=document.getElementById("role-dropdown"),c=document.getElementById("role-chevron"),m=document.getElementById("selected-role"),g=document.getElementById("register-role"),t&&a?(t.addEventListener("click",()=>h("login")),a.addEventListener("click",()=>h("register")),(()=>{o&&o.addEventListener("submit",p),n&&n.addEventListener("submit",w);const e=document.getElementById("send-reset-link");e&&e.addEventListener("click",y),B()})(),d&&l&&(d.addEventListener("click",e=>{e.preventDefault(),v()}),document.addEventListener("click",e=>{d.contains(e.target)||l.contains(e.target)||L()}),l.querySelectorAll(".role-option").forEach(e=>{e.addEventListener("click",()=>{f(e)})})),document.querySelectorAll(".password-toggle").forEach(e=>{e.addEventListener("click",()=>{const t=e.parentElement.querySelector("input"),a=e.querySelector(".eye-open"),o=e.querySelector(".eye-closed");"password"===t.type?(t.type="text",a.classList.add("hidden"),o.classList.remove("hidden")):(t.type="password",a.classList.remove("hidden"),o.classList.add("hidden"))})}),s&&s.addEventListener("click",e=>{e.preventDefault(),E()}),i&&i.addEventListener("click",()=>{S()}),"register"===new URLSearchParams(window.location.search).get("tab")&&h("register"),console.log("Auth Page initialized")):console.warn("Auth Page: Required elements not found")},switchTab:h,getState:()=>({...e})}})();function handleLogout(){localStorage.removeItem("optimine-logged-in"),localStorage.removeItem("optimine-user"),localStorage.removeItem("optimine-redirect"),window.OptiMine&&window.OptiMine.Toast&&window.OptiMine.Toast.show("Logged out successfully","success"),setTimeout(()=>{window.location.href="index.html"},500)}function isLoggedIn(){return"true"===localStorage.getItem("optimine-logged-in")}function getUserData(){try{return JSON.parse(localStorage.getItem("optimine-user")||"{}")}catch{return{}}}document.addEventListener("DOMContentLoaded",()=>{(document.getElementById("login-form")||document.getElementById("register-form"))&&AuthPage.init()}),window.handleLogout=handleLogout,window.isLoggedIn=isLoggedIn,window.getUserData=getUserData;