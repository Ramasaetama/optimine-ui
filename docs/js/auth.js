const AuthPage=(()=>{const e={currentView:"login",isLoading:!1,selectedRole:null};let t,n,s,r,o,a,i,d,l,c,m,g;const u=e=>window.OptiMine&&window.OptiMine.LanguageManager?window.OptiMine.LanguageManager.t(e):e,h=a=>{if(e.isLoading)return;e.currentView=a,"login"===a?(t.classList.add("active"),n.classList.remove("active"),s.classList.remove("hidden"),r.classList.add("hidden"),o.classList.add("hidden")):"register"===a&&(t.classList.remove("active"),n.classList.add("active"),s.classList.add("hidden"),r.classList.remove("hidden"),o.classList.add("hidden"));const i=new URL(window.location);i.searchParams.set("tab",a),window.history.replaceState({},"",i),x()},p=async t=>{if(t.preventDefault(),e.isLoading)return;const n=document.getElementById("login-email").value.trim(),r=document.getElementById("login-password").value;if(S(n))if(r){q(!0,s);try{const e=await fetch("http://139.59.224.58:5000/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,password:r})}),t=await e.json();if(!e.ok||t.error)throw new Error(t.message||"Login failed");localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-token",t.data.token),localStorage.setItem("optimine-user",JSON.stringify({id:t.data.id,email:n,name:t.data.nama,role:t.data.role,avatar:null})),P("success",u("auth.loginSuccess")||"Login successful! Redirecting..."),setTimeout(()=>{const e=localStorage.getItem("optimine-redirect")||"index.html";localStorage.removeItem("optimine-redirect"),window.location.href=e},1500)}catch(e){P("error",e.message||u("auth.loginError")||"Invalid email or password")}finally{q(!1,s)}}else B("login-password",u("auth.passwordRequired")||"Password is required");else B("login-email",u("auth.invalidEmail")||"Please enter a valid email address")},w=async t=>{if(t.preventDefault(),e.isLoading)return;const n=document.getElementById("register-name").value.trim(),s=document.getElementById("register-email").value.trim(),o=document.getElementById("register-password").value,a=document.getElementById("register-confirm-password").value,i=document.getElementById("register-role").value;let d=!1;if((!n||n.length<2)&&(B("register-name",u("auth.nameRequired")||"Please enter your full name"),d=!0),S(s)||(B("register-email",u("auth.invalidEmail")||"Please enter a valid email address"),d=!0),o.length<8&&(B("register-password",u("auth.passwordMinLength")||"Password must be at least 8 characters"),d=!0),o!==a&&(B("register-confirm-password",u("auth.passwordMismatch")||"Passwords do not match"),d=!0),i||(B("role-dropdown-btn",u("auth.roleRequired")||"Please select a role"),d=!0),!d){q(!0,r);try{const e={nama:n,email:s,password:o,role:i};console.log("Sending registration data:",e);const t=await fetch("http://139.59.224.58:5000/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),r=await t.json();if(console.log("Registration response:",r),!t.ok||r.error)throw new Error(r.message||"Registration failed");const a=await fetch("http://139.59.224.58:5000/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,password:o})}),d=await a.json();a.ok&&!d.error?(localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-token",d.data.token),localStorage.setItem("optimine-user",JSON.stringify({id:d.data.id,email:s,name:d.data.nama,role:d.data.role,avatar:null}))):(localStorage.setItem("optimine-logged-in","true"),localStorage.setItem("optimine-user",JSON.stringify({email:s,name:n,role:i,avatar:null}))),P("success",u("auth.registerSuccess")||"Account created successfully! Redirecting..."),setTimeout(()=>{window.location.href="index.html"},1500)}catch(e){P("error",e.message||u("auth.registerError")||"Registration failed. Please try again.")}finally{q(!1,r)}}},y=async()=>{if(e.isLoading)return;const t=document.getElementById("forgot-email").value.trim();if(S(t)){q(!0,o);try{await O(),P("success",u("auth.resetEmailSent")||"Password reset link has been sent to your email.")}catch(e){P("error",u("auth.resetError")||"Failed to send reset link. Please try again.")}finally{q(!1,o)}}else B("forgot-email",u("auth.invalidEmail")||"Please enter a valid email address")},v=()=>{l.classList.contains("hidden")?(l.classList.remove("hidden"),c.classList.add("open")):L()},L=()=>{l.classList.add("hidden"),c.classList.remove("open")},f=t=>{const n=t.dataset.value,s=t.querySelector("span").textContent;e.selectedRole=n,g.value=n,m.textContent=s,m.classList.remove("text-muted-foreground"),m.classList.add("text-foreground"),l.querySelectorAll(".role-option").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),L(),k("role-dropdown-btn")},E=()=>{e.currentView="forgot",s.classList.add("hidden"),r.classList.add("hidden"),o.classList.remove("hidden"),t.parentElement.classList.add("hidden")},I=()=>{e.currentView="login",o.classList.add("hidden"),s.classList.remove("hidden"),t.parentElement.classList.remove("hidden")},S=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),b=()=>{document.querySelectorAll('input[type="email"]').forEach(e=>{e.addEventListener("blur",()=>{e.value&&!S(e.value)?B(e.id,u("auth.invalidEmail")||"Please enter a valid email address"):k(e.id)})});const e=document.getElementById("register-confirm-password"),t=document.getElementById("register-password");e&&t&&e.addEventListener("blur",()=>{e.value&&e.value!==t.value?B("register-confirm-password",u("auth.passwordMismatch")||"Passwords do not match"):k("register-confirm-password")})},B=(e,t)=>{const n=document.getElementById(e);if(!n)return;n.classList.add("error");const s=n.parentElement.querySelector(".error-message");s&&s.remove();const r=document.createElement("p");r.className="error-message",r.textContent=t,n.parentElement.appendChild(r)},k=e=>{const t=document.getElementById(e);if(!t)return;t.classList.remove("error");const n=t.parentElement.querySelector(".error-message");n&&n.remove()},x=()=>{document.querySelectorAll(".auth-input.error").forEach(e=>{e.classList.remove("error")}),document.querySelectorAll(".error-message").forEach(e=>e.remove())},q=(t,n)=>{e.isLoading=t;const s=n.querySelector(".auth-submit")||n.querySelector('button[type="submit"]')||n.querySelector("#send-reset-link");s&&(t?(s.classList.add("loading"),s.disabled=!0,s.querySelector(".loading-spinner")?.classList.remove("hidden")):(s.classList.remove("loading"),s.disabled=!1,s.querySelector(".loading-spinner")?.classList.add("hidden")))},P=(e,t)=>{window.OptiMine&&window.OptiMine.Toast?window.OptiMine.Toast.show(t,e):alert(t)},O=()=>new Promise(e=>{setTimeout(e,1500)});return{init:()=>{t=document.getElementById("login-tab"),n=document.getElementById("register-tab"),s=document.getElementById("login-form"),r=document.getElementById("register-form"),o=document.getElementById("forgot-password-form"),a=document.getElementById("forgot-password-link"),i=document.getElementById("back-to-login"),d=document.getElementById("role-dropdown-btn"),l=document.getElementById("role-dropdown"),c=document.getElementById("role-chevron"),m=document.getElementById("selected-role"),g=document.getElementById("register-role"),t&&n?(t.addEventListener("click",()=>h("login")),n.addEventListener("click",()=>h("register")),(()=>{s&&s.addEventListener("submit",p),r&&r.addEventListener("submit",w);const e=document.getElementById("send-reset-link");e&&e.addEventListener("click",y),b()})(),d&&l&&(d.addEventListener("click",e=>{e.preventDefault(),v()}),document.addEventListener("click",e=>{d.contains(e.target)||l.contains(e.target)||L()}),l.querySelectorAll(".role-option").forEach(e=>{e.addEventListener("click",()=>{f(e)})})),document.querySelectorAll(".password-toggle").forEach(e=>{e.addEventListener("click",()=>{const t=e.parentElement.querySelector("input"),n=e.querySelector(".eye-open"),s=e.querySelector(".eye-closed");"password"===t.type?(t.type="text",n.classList.add("hidden"),s.classList.remove("hidden")):(t.type="password",n.classList.remove("hidden"),s.classList.add("hidden"))})}),a&&a.addEventListener("click",e=>{e.preventDefault(),E()}),i&&i.addEventListener("click",()=>{I()}),(()=>{const e=document.getElementById("register-password"),t=document.getElementById("password-info-container"),n=document.getElementById("password-strength-container"),s=document.getElementById("password-strength-text"),r=[document.getElementById("strength-bar-1"),document.getElementById("strength-bar-2"),document.getElementById("strength-bar-3"),document.getElementById("strength-bar-4")],o=document.getElementById("req-length"),a=document.getElementById("req-uppercase"),i=document.getElementById("req-number");if(!e||!t)return;const d=e=>{const t={en:["","Weak","Fair","Good","Strong"],id:["","Lemah","Cukup","Baik","Kuat"]};return(t[localStorage.getItem("optimine-language")||"id"]||t.id)[e]||""},l=(e,t)=>{if(!e)return;const n=e.querySelector("span"),s=n?n.textContent:"";t?(e.classList.remove("text-muted-foreground"),e.classList.add("text-green-500"),e.innerHTML=`\n                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>\n                    </svg>\n                    <span>${s}</span>\n                `):(e.classList.add("text-muted-foreground"),e.classList.remove("text-green-500"),e.innerHTML=`\n                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <circle cx="12" cy="12" r="10" stroke-width="2"/>\n                    </svg>\n                    <span>${s}</span>\n                `)},c=e=>{const t={0:{bar:"bg-secondary",text:"",color:""},1:{bar:"bg-red-500",text:"text-red-500",color:d(1)},2:{bar:"bg-orange-500",text:"text-orange-500",color:d(2)},3:{bar:"bg-yellow-500",text:"text-yellow-500",color:d(3)},4:{bar:"bg-green-500",text:"text-green-500",color:d(4)}}[e];r.forEach((n,s)=>{n&&(n.className="h-1.5 flex-1 rounded-full transition-colors duration-300",s<e?n.classList.add(t.bar):n.classList.add("bg-secondary"))}),s&&(s.textContent=t.color,s.className=`text-xs font-medium ${t.text}`)};e.addEventListener("focus",()=>{t.classList.remove("hidden")}),e.addEventListener("blur",()=>{e.value||(t.classList.add("hidden"),n?.classList.add("hidden"))}),e.addEventListener("input",e=>{const s=e.target.value;if(t.classList.remove("hidden"),s.length>0){n?.classList.remove("hidden");const{strength:e,checks:t}=(e=>{let t=0;const n={length:e.length>=8,uppercase:/[A-Z]/.test(e),number:/[0-9]/.test(e),lowercase:/[a-z]/.test(e),special:/[!@#$%^&*(),.?":{}|<>]/.test(e)};return n.length&&t++,n.uppercase&&t++,n.number&&t++,(n.special||n.lowercase&&e.length>=10)&&t++,{strength:t,checks:n}})(s);l(o,t.length),l(a,t.uppercase),l(i,t.number),c(e)}else n?.classList.add("hidden"),c(0),l(o,!1),l(a,!1),l(i,!1)})})(),"register"===new URLSearchParams(window.location.search).get("tab")&&h("register"),console.log("Auth Page initialized")):console.warn("Auth Page: Required elements not found")},switchTab:h,getState:()=>({...e})}})();function handleLogout(){localStorage.removeItem("optimine-logged-in"),localStorage.removeItem("optimine-user"),localStorage.removeItem("optimine-redirect"),window.OptiMine&&window.OptiMine.Toast&&window.OptiMine.Toast.show("Logged out successfully","success"),setTimeout(()=>{window.location.href="index.html"},500)}function isLoggedIn(){return"true"===localStorage.getItem("optimine-logged-in")}function getUserData(){try{return JSON.parse(localStorage.getItem("optimine-user")||"{}")}catch{return{}}}document.addEventListener("DOMContentLoaded",()=>{(document.getElementById("login-form")||document.getElementById("register-form"))&&AuthPage.init()}),window.handleLogout=handleLogout,window.isLoggedIn=isLoggedIn,window.getUserData=getUserData;